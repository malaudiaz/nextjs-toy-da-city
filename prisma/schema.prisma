generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  name            String
  email           String?  @unique
  phone           String?
  clerkId         String   @unique
  role            String   @default("buyer")
  stripeAccountId String?  @unique
  onboardingUrl   String?
  reputation      Float?   @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  lastSeen DateTime @default(now()) // Última vez que estuvo activo

  // Relaciones
  toysForSale    Toy[]         @relation("Seller")
  favoriteToys   FavoriteToy[]
  //purchaseHistory Transaction[] @relation("Buyer")
  //salesHistory    Transaction[] @relation("Seller")
  ordersAsBuyer  Order[]       @relation("Buyer")
  ordersAsSeller Order[]       @relation("Seller")

  reviewsGiven    Review[] @relation("ReviewAuthor")
  reviewsReceived Review[] @relation("ReviewTarget")

  sentMessages      Message[]          @relation("MessageSender")
  receivedMessages  Message[]          @relation("MessageReceiver")
  pushSubscriptions PushSubscription[]

  giftrequests          GiftRequest[]

  @@map("users")
}

model Language {
  id           String        @id @default(uuid())
  code         String        @unique // "en", "es"
  name         String
  translations Translation[]
  createdAt    DateTime      @default(now())

  @@map("languages")
}

model Translation {
  id          String     @id @default(uuid())
  key         String
  value       String
  language    Language   @relation(fields: [languageId], references: [id])
  languageId  String
  category    Category?  @relation(fields: [categoryId], references: [id])
  categoryId  Int?
  condition   Condition? @relation(fields: [conditionId], references: [id])
  conditionId Int?
  status      Status?    @relation(fields: [statusId], references: [id])
  statusId    Int?
  createdAt   DateTime   @default(now())

  @@unique([languageId, key, categoryId, conditionId, statusId])
  @@map("translations")
}

model Category {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  description  String?
  userId       String
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  translations Translation[]
  toys         Toy[]

  @@map("categories")
}

model Status {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  description  String?
  userId       String
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  translations Translation[]
  toys         Toy[]
  giftrequests    GiftRequest[]
  //transactions Transaction[]

  @@map("statuses")
}

model Condition {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  description  String?
  userId       String
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  translations Translation[]
  toys         Toy[]

  @@map("conditions")
}

model Toy {
  id          String        @id @default(uuid())
  title       String
  description String
  price       Float
  location    String?
  categoryId  Int
  category    Category      @relation(fields: [categoryId], references: [id])
  statusId    Int
  status      Status        @relation(fields: [statusId], references: [id])
  conditionId Int
  condition   Condition     @relation(fields: [conditionId], references: [id])
  sellerId    String
  seller      User          @relation("Seller", fields: [sellerId], references: [id])
  //transactions Transaction[]
  forSell     Boolean       @default(true)
  forGifts    Boolean       @default(true)
  forChanges  Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  isActive    Boolean       @default(true)
  media       Media[]
  favorites   FavoriteToy[]
  orderItems  OrderItem[] // Relación inversa
  Message     Message[]      @relation("MessageToy")

  giftrequests      GiftRequest[]      // Solicitudes donde este juguete es el deseado
  exchangerequested GiftRequest[]    @relation("exchange_toy") // Solicitudes donde este juguete se ofrece en intercambio

  @@map("toys")
}

model Media {
  id      String   @id @default(uuid())
  fileUrl String
  type    FileType
  toyId   String
  toy     Toy      @relation(fields: [toyId], references: [id])

  @@map("media")
}

enum FileType {
  IMAGE
  VIDEO
}

model FavoriteToy {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  toyId     String
  toy       Toy      @relation(fields: [toyId], references: [id])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([userId, toyId], name: "unique_favorite")
  @@map("favorite_toys")
}

// ✅ MODELO DE ÓRDENES (clave para el flujo de pago)
model Order {
  id              String      @id @default(uuid())
  cartId          String?     @unique
  paymentIntentId String      @unique @map("payment_intent_id")
  chargeId        String?     @map("charge_id")
  buyerId         String
  buyer           User        @relation("Buyer", fields: [buyerId], references: [id])
  sellerId        String
  seller          User        @relation("Seller", fields: [sellerId], references: [id])
  totalAmount     Int
  status          OrderStatus @default(AWAITING_CONFIRMATION)
  createdAt       DateTime    @default(now())
  confirmedAt     DateTime?
  canceledAt      DateTime?
  transferredAt   DateTime?
  reembursedAt    DateTime?
  items           OrderItem[]

  transfers Transfer[]
  refunds   Refund[]
  
  reviews Review[] // ✅ Add this line for the 1:N relation

  @@index([paymentIntentId])
  @@index([chargeId])
  @@index([buyerId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id              String @id @default(uuid())
  orderId         String
  order           Order  @relation(fields: [orderId], references: [id])
  toyId           String
  toy             Toy    @relation(fields: [toyId], references: [id])
  priceAtPurchase Int // en centavos

  @@map("order_items")
}

enum OrderStatus {
  AWAITING_CONFIRMATION
  CONFIRMED
  CANCELED
  TRANSFERRED
  TRANSFER_IN_PROGRESS
  REEMBURSED
  ERROR
}

model Transfer {
  id               String   @id @default(uuid())
  orderId          String
  orderIdRel       Order    @relation(fields: [orderId], references: [id])
  sellerId         String
  amount           Int // en centavos
  stripeTransferId String   @unique @map("stripe_transfer_id")
  createdAt        DateTime @default(now())

  @@map("transfers")
}

// ✅ NUEVO: Modelo de Reembolso
model Refund {
  id             String   @id @default(uuid())
  orderId        String   @unique
  order          Order    @relation(fields: [orderId], references: [id])
  amount         Int // en centavos
  stripeRefundId String   @unique @map("stripe_refund_id")
  createdAt      DateTime @default(now())

  @@map("refunds")
}

model Message {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String
  createdAt  DateTime @default(now())
  toyId      String?

  // Relaciones
  sender   User @relation("MessageSender", fields: [senderId], references: [clerkId])
  receiver User @relation("MessageReceiver", fields: [receiverId], references: [clerkId])
  toy      Toy? @relation("MessageToy", fields: [toyId], references: [id])

  @@map("messages")
}

model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  keys      Json // { p256dh: string, auth: string }
  userId    String
  user      User     @relation(fields: [userId], references: [clerkId])
  createdAt DateTime @default(now())

  @@map("push_subscriptions")
}

model Review {
  id         String   @id @default(uuid())
  reviewerId String
  reviewer   User     @relation("ReviewAuthor", fields: [reviewerId], references: [id])
  targetId   String
  target     User     @relation("ReviewTarget", fields: [targetId], references: [id])
  rating     Int
  comment    String?
  // ❌ Eliminado @unique para permitir múltiples reseñas por orden
  orderId    String?
  // ✅ Relación 1:N (una orden tiene muchas reseñas)
  order      Order?   @relation(fields: [orderId], references: [id])
  createdAt  DateTime @default(now())

  // ✅ Modificado: asegura que un comprador solo pueda reseñar a un vendedor UNA VEZ por ORDEN
  // Esto permite múltiples reseñas en la misma orden, siempre que el vendedor (targetId) sea diferente.
  @@unique([reviewerId, targetId, orderId])
  @@index([targetId])
  @@map("reviews")
}

model WebhookError {
  id           String   @id @default(cuid())
  clerkId      String
  email        String?
  errorType    String
  errorMessage String
  payload      String?
  createdAt    DateTime @default(now())

  @@index([clerkId])
  @@index([createdAt])
}


model GiftRequest {
  id          String   @id @default(uuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id])
  toyId     String
  toy       Toy      @relation(fields: [toyId], references: [id])
  
  forGifts    Boolean       @default(true)
  forChanges  Boolean       @default(true)

  statusId    Int
  status      Status        @relation(fields: [statusId], references: [id])

  // Fechas
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  exchangeToyId String?  // Opcional porque solo aplica para intercambios
  exchangeToy   Toy?     @relation(fields: [exchangeToyId], references: [id], name: "exchange_toy")
  
  // Garantizar una solicitud por usuario por regalo
  @@unique([toyId, userId], name: "unique_toy_request")
  @@map("gift_requests")

}